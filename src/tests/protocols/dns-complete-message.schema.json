{
  "config": {
    "endianness": "big_endian"
  },
  "types": {
    "Label": {
      "type": "string",
      "kind": "length_prefixed",
      "length_type": "uint8",
      "encoding": "ascii",
      "description": "DNS label (length-prefixed ASCII string)"
    },
    "CompressedLabel": {
      "type": "discriminated_union",
      "discriminator": {
        "peek": "uint8"
      },
      "variants": [
        {
          "type": "Label",
          "when": "value < 0xC0",
          "description": "Regular label"
        },
        {
          "type": "LabelPointer",
          "when": "value >= 0xC0",
          "description": "Pointer to previous label"
        }
      ],
      "description": "DNS label or pointer to previous label"
    },
    "LabelPointer": {
      "type": "back_reference",
      "storage": "uint16",
      "endianness": "big_endian",
      "offset_mask": "0x3FFF",
      "offset_from": "message_start",
      "target_type": "Label",
      "description": "Pointer to previously-seen label (RFC 1035 Section 4.1.4)"
    },
    "CompressedDomain": {
      "type": "array",
      "kind": "null_terminated",
      "items": {
        "type": "CompressedLabel"
      },
      "terminal_variants": ["LabelPointer"],
      "description": "Sequence of labels or pointers (pointers are terminal per RFC 1035)"
    },
    "Question": {
      "sequence": [
        {
          "name": "qname",
          "type": "CompressedDomain",
          "description": "Domain name being queried"
        },
        {
          "name": "qtype",
          "type": "uint16",
          "description": "Question type (1=A, 2=NS, etc.)"
        },
        {
          "name": "qclass",
          "type": "uint16",
          "description": "Question class (1=IN for Internet)"
        }
      ],
      "description": "DNS question entry"
    },
    "ARdata": {
      "sequence": [
        {
          "name": "address",
          "type": "uint32",
          "description": "IPv4 address (32 bits)"
        }
      ],
      "description": "A record RDATA (TYPE=1) - IPv4 address"
    },
    "NSRdata": {
      "sequence": [
        {
          "name": "nsdname",
          "type": "CompressedDomain",
          "description": "Name server domain name"
        }
      ],
      "description": "NS record RDATA (TYPE=2) - Name server domain name"
    },
    "CNAMERdata": {
      "sequence": [
        {
          "name": "cname",
          "type": "CompressedDomain",
          "description": "Canonical name (alias target)"
        }
      ],
      "description": "CNAME record RDATA (TYPE=5) - Canonical name"
    },
    "ResourceRecord": {
      "sequence": [
        {
          "name": "name",
          "type": "CompressedDomain",
          "description": "Domain name this record applies to"
        },
        {
          "name": "type",
          "type": "uint16",
          "description": "RR type (1=A, 2=NS, 5=CNAME, etc.)"
        },
        {
          "name": "class",
          "type": "uint16",
          "description": "RR class (1=IN for Internet)"
        },
        {
          "name": "ttl",
          "type": "uint32",
          "description": "Time to live in seconds"
        },
        {
          "name": "rdlength",
          "type": "uint16",
          "description": "RDATA length in bytes"
        },
        {
          "name": "rdata",
          "type": "discriminated_union",
          "discriminator": {
            "field": "type"
          },
          "variants": [
            {
              "type": "ARdata",
              "when": "value === 1",
              "description": "A record (IPv4 address)"
            },
            {
              "type": "NSRdata",
              "when": "value === 2",
              "description": "NS record (name server)"
            },
            {
              "type": "CNAMERdata",
              "when": "value === 5",
              "description": "CNAME record (canonical name)"
            }
          ],
          "description": "RDATA payload (discriminated by type field)"
        }
      ],
      "description": "DNS resource record"
    },
    "DnsMessage": {
      "sequence": [
        {
          "name": "id",
          "type": "uint16",
          "description": "Transaction ID"
        },
        {
          "name": "flags",
          "type": "bitfield",
          "size": 16,
          "fields": [
            { "name": "qr", "offset": 0, "size": 1, "description": "Query/Response flag" },
            { "name": "opcode", "offset": 1, "size": 4, "description": "Operation code" },
            { "name": "aa", "offset": 5, "size": 1, "description": "Authoritative answer" },
            { "name": "tc", "offset": 6, "size": 1, "description": "Truncation" },
            { "name": "rd", "offset": 7, "size": 1, "description": "Recursion desired" },
            { "name": "ra", "offset": 8, "size": 1, "description": "Recursion available" },
            { "name": "z", "offset": 9, "size": 3, "description": "Reserved (must be 0)" },
            { "name": "rcode", "offset": 12, "size": 4, "description": "Response code" }
          ],
          "description": "DNS header flags"
        },
        {
          "name": "qdcount",
          "type": "uint16",
          "description": "Number of questions"
        },
        {
          "name": "ancount",
          "type": "uint16",
          "description": "Number of answer records"
        },
        {
          "name": "nscount",
          "type": "uint16",
          "description": "Number of authority records"
        },
        {
          "name": "arcount",
          "type": "uint16",
          "description": "Number of additional records"
        },
        {
          "name": "questions",
          "type": "array",
          "kind": "field_referenced",
          "length_field": "qdcount",
          "items": { "type": "Question" },
          "description": "Questions (length from header qdcount)"
        },
        {
          "name": "answers",
          "type": "array",
          "kind": "field_referenced",
          "length_field": "ancount",
          "items": { "type": "ResourceRecord" },
          "description": "Answer records (length from header ancount)"
        },
        {
          "name": "authority",
          "type": "array",
          "kind": "field_referenced",
          "length_field": "nscount",
          "items": { "type": "ResourceRecord" },
          "description": "Authority records (length from header nscount)"
        },
        {
          "name": "additional",
          "type": "array",
          "kind": "field_referenced",
          "length_field": "arcount",
          "items": { "type": "ResourceRecord" },
          "description": "Additional records (length from header arcount)"
        }
      ],
      "description": "Complete DNS message with header and all sections"
    }
  }
}
